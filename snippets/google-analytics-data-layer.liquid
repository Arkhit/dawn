<script>
  (function($) {
    $(document).on("page:load page:change", function() {
      if (typeof window.dataLayer === "undefined") {
        return;
      }

      {% comment %}TODO: Only send purchase event on the first visit{% endcomment %}
      if (Shopify.Checkout.page === "thank_you") {
        dataLayer.push(
          event: "purchase",
          ecommerce: {
            transaction_id: "{{ checkout.order_id }}",
            value: {{ checkout.total_price | money_without_currency }},
            tax: {{ checkout.tax_price | money_without_currency }},
            shipping: {{ checkout.shipping_price | money_without_currency }},
            currency: "USD",
            items: [
              {{ for item in checkout.line_items }}
                {
                  item_id: "{{ item.sku }}"
                  item_name: "{{ item.title }}"
                  price: {{ item.unit_price | money_without_currency }}
                  quantity: {{ item.quantity }}
                }
              {{ endfor }}
            ]
          }
        )
      }
    });
  })(Checkout.$);
</script>
