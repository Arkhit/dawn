<!-- Product detail view GTM dataLayer enhanced eCommerce event -->
<script type="text/javascript" defer="defer">
  console.log('adding productView to cart GTM datalayer')
  var product = {{ product | json }}
  var cart = {{ cart | json }}

  window.dataLayer = window.dataLayer || []
  window.dataLayer.push({ecommerce: null})
  window.dataLayer.push({
    'event': 'viewProduct',
    'ecommerce': {
      'currencyCode': cart.currency,
      'detail': {
        'products': [{
          'name': product.title,
          'id': product.id,
          'price': product.price / 100,
          'brand': product.vendor,
          'category': product.tags[0],
          'variant': product.variants[0].name,
        }]
      }
    }
  })
</script>

<!-- Add to cart GTM dataLayer enhanced eCommerce event -->
<script type="text/javascript" defer="defer">
  console.log('adding add to cart GTM datalayer')
  var product = {{ product | json }}
  var cart = {{ cart | json }}

  var addToCart = document.querySelector('button[name=add]')
  var attach = function() {
    addToCart.addEventListener("click", function(event) {
      window.dataLayer = window.dataLayer || []
      window.dataLayer.push({ecommerce: null})
      window.dataLayer.push({
        'event': 'addToCart',
        'ecommerce': {
          'currencyCode': cart.currency,
          'add': {
            'products': [{
              'name': product.title,
              'id': product.id,
              'price': product.price / 100,
              'brand': product.vendor,
              'category': product.tags[0],
              'variant': product.variants[0].title,
              'quantity': 1
            }]
          }
        }
      })
    })
  }

  var tryAttaching = function() {
    addToCart = document.querySelector('button[name=add]')
    if(addToCart) {
      attach()
    } else {
      setTimeout(tryAttaching, 1)
    }
  }

  tryAttaching()
</script>
