$(document).ready(function () {
    console.log("geo redirect file");
    var language = localStorage.getItem("preferredLang").toLowerCase();
    var country = localStorage.getItem("preferredCont").toLowerCase();
    var cancelled = localStorage.getItem("cancelledModal");
    if (!country && !language && !cancelled) {
      fetch(
        "/browsing_context_suggestions.json?source=geolocation_recommendation&country[enabled]=true&language[enabled]=true"
      )
        .then(async (response) => {
          // get json response here
          let data = await response.json();
          console.log(data);
          if (response.status === 200) {
            console.log(data.detected_values.country.name);
            let userCountry = data.detected_values.country;
  
            //check if user is from germany and visits BE(.com) store
            if (
              userCountry.handle.toLowerCase() == "de" &&
              userCountry.name.toLowerCase() == "germany" &&
              Shopify.country == "BE"
            ) {
              $(".modal").css("display", "flex");
            } else {
              setLocaleDetails();
            }
          }
        })
        .catch((error) => {
          console.log(error);
        });
    } else {
      if (
        Shopify.locale.toLowerCase() != language ||
        Shopify.country.toLowerCase() != country
      ) {
        let redirectLink = "";
        let parameters = "/";
        if (language == "en" && country == "be") {
          redirectLink = "/";
        } else {
          if (country == "be") {
            redirectLink = `/${language}`;
          } else {
            redirectLink = `/${language}-${country}`;
          }
        }
        console.log("user language/country doesn't match");
        $("#country_code").val(country);
        $("#locale_code").val(language);
        $("#suggested").click();
        // window.location.replace(redirectLink);
      } else {
        console.log("user language/country matched!!");
        // setLocaleDetails();
      }
    }
    $(".close-lang, .modal-span").click(function () {
      console.log("user cancelled");
      setLocaleDetails();
    });
    function setLocaleDetails() {
      localStorage.setItem("preferredLang", Shopify.locale);
      localStorage.setItem("preferredCont", Shopify.country);
      localStorage.setItem("cancelledModal", "true");
    }
  });
  
  // ============================================================================
  
  // var closeIcons = document.getElementsByClassName('pop-close');
  // var redirectLink = '';
  // document.querySelectorAll('link[hreflang="de"]').forEach((summary) => {
  //   redirectLink = summary.href;
  // });
  // function hidePopup() {
  //   document.querySelectorAll('.show-recommended').forEach((summary) => {
  //     summary.style.display = 'none';
  //   });
  //   localStorage.setItem('cancelled', 'yes');
  // }
  // function showPopup() {
  //   document.querySelectorAll('.show-recommended').forEach((summary) => {
  //     summary.style.display = 'block';
  //   });
  // }
  
  // var country = localStorage.getItem('cont');
  // var language = localStorage.getItem('lang');
  // var cancelled = localStorage.getItem('cancelled');
  /*
  if (!country && !language && !cancelled) {
    fetch(
      '/browsing_context_suggestions.json?source=geolocation_recommendation&country[enabled]=true&language[enabled]=true'
    )
      .then(async (response) => {
        console.log("geo redirect response: " + response)
        // get json response here
        let data = await response.json();
  
        if (response.status === 200) {
          var languageX = window.navigator.userLanguage || window.navigator.language;
          // localStorage.setItem('lang', languageX);
          // localStorage.setItem('cont', data.detected_values.country.handle);
          if (redirectLink != '') {
            if (data.detected_values.country.handle == 'DE') {
              var urlSplits = window.location.href.split('?');
              var parameters = '';
              if (urlSplits.length > 1) {
                parameters = '?' + urlSplits[1];
              }
              document.getElementById('redirect-link').href = redirectLink + parameters;
              // window.location.replace(redirectLink + parameters);
              // showPopup();
            }
          }
        }
      })
      .catch((error) => {
        console.log(error);
      });
  }
  if (!cancelled && redirectLink != '') {
    if (country == 'DE') {
      var urlSplits = window.location.href.split('?');
      var parameters = '';
      if (urlSplits.length > 1) {
        parameters = '?' + urlSplits[1];
      }
      document.getElementById('redirect-link').href = redirectLink + parameters;
      // window.location.replace(redirectLink + parameters);
      // showPopup();
    }
  }
  for (i = 0; i < closeIcons.length; i++) {
    closeIcons[i].addEventListener('click', hidePopup);
  }
  
  */
  